---
# tasks file for pihole-update

- name: backup pihole
  ansible.builtin.command: 
   cmd: 'pihole -a -t'
  args:
    chdir: "{{ syncthing_dir }}"

- name: update pihole
  ansible.builtin.command: 
    cmd: 'pihole -up'

- name: create whitelist directory
  ansible.builtin.file:
    path: /opt/whitelist/
    state: directory

- name: grab whitelist from source control
  ansible.builtin.git:
    repo: 'https://github.com/anudeepND/whitelist.git'
    dest: /opt/whitelist/
    force: true

- name: run the whitelist update script
  ansible.builtin.script:
    chdir: whitelist/scripts/
    cmd: whitelist.py

- name: add ninas work laptop domain to dnsmasq 
  ansible.builtin.template:
    src: 07-nina-work-laptop.conf.j2
    dest: /etc/dnsmasq.d/07-nina-work-laptop.conf
    backup: yes
  notify:
    - restart pihole-FTL

- name: update dnsmasq configuration to allow active-active dns
  ansible.builtin.template:
    src: 02-pihole-dhcp.conf.j2
    dest: /etc/dnsmasq.d/02-pihole-dhcp.conf
    backup: yes
  notify:
    - restart pihole-FTL
